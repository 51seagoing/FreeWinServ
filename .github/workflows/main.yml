name: Remote Desktop Entry

on:
  workflow_dispatch:
    inputs:
      type:
        description: |
          ▼ Windows 远程桌面:
          win-cf  → Cloudflared (国外推荐)
          win-ng  → Ngrok (国内推荐)
          
          ▼ Linux 远程桌面:
          linux-xfce → XFCE (轻量快速)
          linux-mate → MATE (完整体验)
          linux-lxde → LXDE (超轻量级)
        required: true
        default: 'win-cf'
        type: choice
        options:
          - 'win-cf'
          - 'win-ng'
          - 'linux-xfce'
          - 'linux-mate'
          - 'linux-lxde'
      os_type:
        description: |
          选择 Ubuntu 版本:
        required: false
        default: 'Ubuntu Latest (推荐)'
        type: choice
        options:
          - 'Ubuntu Latest (推荐)'
          - 'Ubuntu 22.04 LTS'
          - 'Ubuntu 20.04 LTS'
      browser:
        description: |
          选择浏览器:
        required: false
        default: 'Firefox (推荐)'
        type: choice
        options:
          - 'Firefox (推荐)'
          - 'Chrome'
          - 'Chromium'
      password:
        description: '远程桌面密码 (默认: P@ssw0rd!)'
        required: false
        default: 'P@ssw0rd!'
      timeout:
        description: '运行时间 (60-360分钟，默认360)'
        required: true
        default: '360'
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      config: ${{ steps.config.outputs.config }}
    steps:
      - id: config
        run: |
          # 定义显示名称映射
          declare -A display_names=(
            ["win-cf"]="Windows + Cloudflared (国外)"
            ["win-ng"]="Windows + Ngrok (国内)"
            ["linux-xfce"]="Linux + XFCE (推荐)"
            ["linux-mate"]="Linux + MATE"
            ["linux-lxde"]="Linux + LXDE (轻量)"
          )
          
          # 配置转换
          case "${{ github.event.inputs.type }}" in
            "win-cf") 
              echo "::set-output name=config::{
                \"type\":\"windows\",
                \"tunnel\":\"cloudflared\",
                \"timeout\":\"${{ github.event.inputs.timeout }}\"
              }"
              echo "选择了: ${display_names[${{ github.event.inputs.type }}]}"
              ;;
            "win-ng") 
              echo "::set-output name=config::{
                \"type\":\"windows\",
                \"tunnel\":\"ngrok\",
                \"timeout\":\"${{ github.event.inputs.timeout }}\"
              }"
              echo "选择了: ${display_names[${{ github.event.inputs.type }}]}"
              ;;
            "linux-xfce"|"linux-mate"|"linux-lxde")
              desktop="${{ github.event.inputs.type }}"
              desktop=${desktop#linux-}  # 移除 'linux-' 前缀
              
              # 处理 OS 类型
              os_version=""
              case "${{ github.event.inputs.os_type }}" in
                "Ubuntu Latest (推荐)") os_version="ubuntu-latest" ;;
                "Ubuntu 22.04 LTS") os_version="ubuntu-22.04" ;;
                "Ubuntu 20.04 LTS") os_version="ubuntu-20.04" ;;
              esac
              
              # 处理浏览器类型
              browser=""
              case "${{ github.event.inputs.browser }}" in
                "Firefox (推荐)") browser="firefox" ;;
                "Chrome") browser="chrome" ;;
                "Chromium") browser="chromium" ;;
              esac
              
              echo "::set-output name=config::{
                \"type\":\"linux\",
                \"desktop\":\"${desktop}\",
                \"os\":\"${os_version}\",
                \"browser\":\"${browser}\",
                \"timeout\":\"${{ github.event.inputs.timeout }}\"
              }"
              echo "选择了: ${display_names[${{ github.event.inputs.type }}]}"
              ;;
          esac

  windows:
    needs: setup
    if: fromJson(needs.setup.outputs.config).type == 'windows'
    uses: ./.github/workflows/windows.yml
    with:
      tunnel: ${{ fromJson(needs.setup.outputs.config).tunnel }}
      password: ${{ github.event.inputs.password }}
      timeout: ${{ github.event.inputs.timeout }}
    secrets: inherit

  linux:
    needs: setup
    if: fromJson(needs.setup.outputs.config).type == 'linux'
    uses: ./.github/workflows/linux.yml
    with:
      os: ${{ fromJson(needs.setup.outputs.config).os }}
      desktop: ${{ fromJson(needs.setup.outputs.config).desktop }}
      browser: ${{ fromJson(needs.setup.outputs.config).browser }}
      password: ${{ github.event.inputs.password }}
      timeout: ${{ github.event.inputs.timeout }}
    secrets: inherit